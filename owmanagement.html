<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>北京经贸学院管理系统</title>
    <link rel="stylesheet" type="text/css" href="jquery-easyui-1.5.2/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="jquery-easyui-1.5.2/themes/icon.css">
    <link rel="stylesheet" href="css/global.css">
    <script type="text/javascript" src="jquery-easyui-1.5.2/jquery.min.js"></script>
    <script type="text/javascript" src="jquery-easyui-1.5.2/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="jquery-easyui-1.5.2/locale/easyui-lang-zh_CN.js"></script>
    <script charset="utf-8" src="kindeditor/kindeditor-all.js"></script>
    <script charset="utf-8" src="kindeditor/lang/zh-CN.js"></script>
</head>
<body>
<div class="easyui-layout" id="cc" style="width:100%; height: 100%;">
    <div data-options="region:'west',split:true" title="官网菜单列表" style="width:170px;">
        <ul id="offmenu" class="easyui-tree">
        </ul>
    </div>
    <div data-options="region:'center'">
        <table class="easyui-datagrid" style="width:100%;height:550px"
               title="图文信息列表" toolbar="#tb"
               singleSelect="true" fitColumns="true" id="articlelist">
        </table>
    </div>
</div>

<div id="addialog" class="easyui-dialog" shadow="false" closed="true" style="width:100%;height:500px;padding:10px">
    <form action="" id="formlist">
        <table cellpadding="5" width="100%">
            <tr>
                <td>标题:</td>
                <td><input class="easyui-validatebox" type="text" name="title"></input></td>
                <td>摘要:</td>
                <td><input class="easyui-validatebox" data-options="required:true" type="text" name="summary"></input></td>
            </tr>
            <tr>
                <td>排序值:</td>
                <td><input class="easyui-validatebox" type="text" name="order_num"></input></td>
                <td>作者/来源:</td>
                <td><input class="easyui-validatebox" type="text" name="auther"></input></td>
            </tr>
            <tr>
                <td>封面</td>
                <td colspan="3"><input class="easyui-filebox" id="uploadcover" style="width: 300px" buttonText='封面上传' type="text" name="cover_img"><a href="javascript:void(0)" class="easyui-linkbutton" style="margin-left:10px;" onclick="submitCover()">上传</a><input type="hidden" name="coverImg"></td>
            </tr>
            <tr>
                <td>
                    内容
                </td>
                <td colspan="3">
                   <textarea id="editor" name="content" style="width:100%;height:350px;">
                </textarea>
                </td>
            </tr>
        </table>
    </form>
    <p class="error hide">您还有未填的项目，无法提交！</p>
</div>
<div id="modifymenu" class="easyui-dialog" shadow="false" closed="true" style="width:400px;height:300px;padding:10px">
    <form action="" id="menuformlist">
        <table cellpadding="5">
            <!--<tr>-->
                <!--<td>菜单名:</td>-->
                <!--<td><input class="easyui-validatebox" data-options="required:true" type="text" name="name"></input></td>-->
            <!--</tr>-->
            <!--<tr>-->
                <!--<td>菜单下的内容类型:</td>-->
                <!--<td><input class="easyui-combobox" data-options="editable:false"type="text" name="contentType"></input></td>-->

            <!--</tr>-->
            <!--<tr>-->
                <!--<td>页面跳转时存储跳转的url(内容类型为页面跳转时填写):</td>-->
                <!--<td><input class="easyui-validatebox" type="text" name="expand"></input></td>-->

            <!--</tr>-->
            <tr>
                <td>文档列表展示类型:</td>
                <td><input class="easyui-combobox" data-options="editable:false"type="text" name="showType"></input></td>
            </tr>
            <!--<tr>-->
                <!--<td>是否在官网首页显示:</td>-->
                <!--<td><input class="easyui-combobox" data-options="editable:false"type="text" name="isShow"></input></td>-->
            <!--</tr>-->
            <tr>
                <td>排序:</td>
                <td><input class="easyui-validatebox" type="text" name="orderNum"></input></td>
            </tr>
        </table>
    </form>
    <p class="error hide">您还有未填的项目，无法提交！</p>
</div>
<div id="tb" style="padding:5px;height:auto">
    <div style="margin-bottom:5px">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="addrow()">起草</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="editrow()">编辑</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="deleterow()">删除</a>
        <!--<a href="javascript:void(0)" class="easyui-linkbutton" onclick="modifymenu()">修改菜单属性</a>-->
    </div>
</div>
<script src="js/common.js"></script>
<script>
    var menuId = null
    var editRowIndex = null;
    var show_type = [
        {value: 1, text: '显示第一篇内容'},
        {value: 2, text: '标题'},
        {value: 3, text: '封面标题可点击'},
        {value: 4, text: '封面标题不可点击 '},
        {value: 5, text: '封面标题摘要可点击 '}
    ]
    $("input[name=showType]").combobox({
        data: show_type,
        valueField: 'value',
        textField: 'text'
    })
    KindEditor.ready(function(K) {
        window.editor = K.create('#editor', {
            uploadJson : commonURL + 'editor/jsp/upload_json.jsp',
            fileManagerJson : commonURL + 'editor/jsp/file_manager_json.jsp',
            allowFileManager : true
        });
    });
    function submitCover() {
        var file = $("#formlist input[name=cover_img]").get(0).files[0]
        if (file != undefined) {
            var fd = new FormData()
            fd.append('file', file)
            fd.append('filetype', 10)
            $.ajax({
                url: commonURL + 'm/file/up.do',
                type: "post",
                dataType: "json",
                data: fd,
                processData: false,
                contentType: false,
                success: function (json) {
                    if (json["success"]) {
                        $("#formlist input[name=coverImg]").val(json.data.list[0]["mename"])
                        $.messager.alert('提示', '上传成功！', 'info');

                    } else {
                        alert(json.msg);
                    }
                }
            });
        }else{
            alert("未操作")
        }
    }

    $.post(commonURL + 'm/role/cannewsMenuList.do', {menuId: 43}, function(json){
        if(json.success){
            $("#offmenu").tree({
                data: json.data.rows,
                onClick: function(node){
//                    if(node.parent_id != null){
                        var classid = node.id
                        menuId = classid
//                        console.log(classid)
                        $("#articlelist").datagrid('reload', {
                            menuId: classid
                        })

                        $("#modifymenu").dialog({
                            closed: true,
                            title: '菜单修改',
                            buttons: [{
                                text: '保存',
                                iconCls: 'icon-ok',
                                handler: function () {
                                    var formdata = $("#menuformlist").serializeArray()
                                    var postdata = {}
                                    $.each(formdata,
                                        function (i) {
                                            postdata[formdata[i]["name"]] = formdata[i]["value"]
                                        })
//                                    if(postdata.showType == ""){
//                                        alert("摘要长度过长")
//                                        return false
//                                    }

                                    postdata.menuId = menuId
                                    updateMenu(postdata)
                                }
                            }]
                        })
//                    }else{
//                        menuId = null
//                    }
                }
            })
        }else{
            alert(json.msg)
        }
    }, 'json')

    function setHeight(){
        var c = $('#cc');
        var p = c.layout('panel','center');	// get the center panel
        var oldHeight = p.panel('panel').outerHeight();
        p.panel('resize', {height:'auto'});
        var newHeight = p.panel('panel').outerHeight();
        c.layout('resize',{
            height: (c.height() + newHeight - oldHeight)
        });
    }
    $(function(){
        $('#cc').layout();
        setHeight();
    });
    var editRowIndex = null;

    $('#articlelist').datagrid({
        url: commonURL + 'm/news/list.do',
        pagination: true,
        pageSize: 10,
        pageList: [10],
        queryParams:{
//            menuId: classid
        },
        loadFilter: function (data) {
            if (data.data) {
                return data.data;
            } else {
                return data;
            }
        },
        onBeforeLoad: function (param) {
            var startNum = Number(param.rows) * Number(param.page) - 10
            param["startNum"] = startNum
            param["perNum"] = param.rows;
        },
        columns: [[
            {field: 'id', title: '编号', width: 20},
            {field: 'title', title: '标题', width: 40},
            {field: 'auther', title: '作者', width: 40},
            {field: 'order_num', title: '排序值', width: 40}
        ]],
        onSelect: function (index, row) {

                editRowIndex = index

        }
    });

    function updateMenu(changes) {
        $.post(commonURL + 'm/webmenu/editWebmenu.do', changes, function (json) {
            if (json.success) {
                $.messager.alert('提示', '修改成功！', 'info');
                $("#modifymenu").dialog("close")
                window.editor.html('')
                $("#menuformlist").form('clear');
            } else {
                alert(json.msg)
            }
        }, 'json')
    }

    function updateRow(changes) {
        $.post(commonURL + 'm/news/edit.do', changes, function (json) {
            if (json.success) {
                $.messager.alert('提示', '修改成功！', 'info');
                $("#addialog").dialog("close")
                window.editor.html('')
                $("#formlist").form('clear');
                console.log(changes)
                $('#articlelist').datagrid('updateRow',{
                    index: editRowIndex,
                    row: changes
                });
            } else {
                alert(json.msg)
            }
        }, 'json')
    }

    function addrow() {
        if($('#offmenu').tree('getSelected') == null){
            $.messager.alert('提示', '未选择图文列表', 'error');
            return false;
        }
        opdialog(1)
        $("#addialog").dialog("open")
    }

    function opdialog(optype, newsId) {
        $("#addialog").dialog({
            closed: true,
            title: optype==1?'添加文章':'信息修改',
            buttons: [{
                text: '保存',
                iconCls: 'icon-ok',
                handler: function () {
                    var formdata = $("#formlist").serializeArray()
                    var postdata = {}
                    $.each(formdata,
                        function (i) {
                            postdata[formdata[i]["name"]] = formdata[i]["value"]
                        })
//                    if(postdata.summary.length > 60){
//                        alert("摘要长度过长")
//                        return false
//                    }

                    $("#addialog .error").addClass("hide")

                    if(optype === 2){
                        postdata.newsId = newsId
                    }
                    if(optype === 1){
                        postdata.menuId = $('#offmenu').tree('getSelected').id
                    }
                    postdata.content = editor.html()
                    optype==1?insertRow(postdata):updateRow(postdata)
                }
            }]
        })
    }

    function insertRow(postdata) {
        $.post(commonURL + 'm/news/add.do', postdata, function (json) {
            if (json.success) {
                window.editor.html('')
                $("#formlist").form('clear');
                $("#addialog").dialog("close")
                alert("添加成功")
                $("#articlelist").datagrid('reload', {
                    menuId: $('#offmenu').tree('getSelected').id
                })
            } else {
                alert(json.msg)
            }
        }, 'json')
    }

    function deleterow() { //删除记录
        var rowIndex = getRowIndex($('#articlelist'))
        var row = $('#articlelist').datagrid('getSelected')
        $.messager.confirm('提示', '你确定要删除这条记录吗？', function (r) {
            if (r) {
                $.post(commonURL + 'm/news/del.do', {newsId: row.id}, function (json) {
                    if (json.success) {
                        $('#articlelist').datagrid('deleteRow', rowIndex);
                    } else {
                        alert(json.msg)
                    }
                }, 'json')
            }
        });
    }

    function editrow() {
//        var rowIndex = getRowIndex($('#articlelist'))
//        editRowIndex = rowIndex
        if($('#offmenu').tree('getSelected') == null){
            $.messager.alert('提示', '未选择官网菜单', 'error');
            return false;
        }
        var row = $('#articlelist').datagrid('getSelected')
        $.post(commonURL + 'm/news/info.do', {newsId: row.id}, function (json) {
            if(json.success){
                var data = json.data
                $("#uploadcover").filebox("setText", data.cover_img)
                window.editor.html(data.content)
                $('#formlist').form('load', data);
                opdialog(2, row.id)
                $("#addialog").dialog("open")
            }else{
                alert(json.msg)
            }
        })

    }

    function modifymenu(){
        if(menuId == null){
            alert("菜单未选择")
            return false
        }
        $("#modifymenu").dialog("open")
    }
</script>
</body>
</html>